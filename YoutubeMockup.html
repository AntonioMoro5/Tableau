<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buscador MÃºsica YouTube - API / Local</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
#search-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
#search-form input, #search-form button, #search-form select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
#search-form button { background: #ff0000; color: white; border: none; cursor: pointer; font-weight: bold; }
#results-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.item { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; }
.item:hover { transform: scale(1.03); }
.item img { width: 100%; border-radius: 6px; cursor: pointer; }
.item h3 { font-size: 1em; margin: 10px 0 5px; height: 2.8em; overflow: hidden; }
.item p { margin: 3px 0; font-size: 0.9em; color: #333; }
.item input[type="checkbox"] { margin-bottom: 10px; }
#player-area { margin-top: 30px; background: #222; border-radius: 10px; padding: 20px; text-align: center; }
#player-area iframe { width: 100%; max-width: 700px; height: 400px; border: none; display: block; }
#player-area p { color: white; }
#load-more { margin: 20px auto; display: block; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
#view-toggle { margin-left: 10px; }

/* Modal pantalla completa */
#fullscreen-modal {
    display: none;
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}
#fullscreen-modal iframe {
    width: 90%;
    height: 90%;
}
#close-fullscreen {
    position: absolute;
    top:10px;
    right:10px;
    padding: 10px 15px;
    font-size: 18px;
    background: red;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
</style>
</head>
<body>

<h1>ðŸŽ§ Buscador MÃºsica YouTube - API / Local</h1>

<div id="search-form">
    <input type="text" id="query" placeholder="Ej: Coldplay, Queen Greatest Hits...">
    <button onclick="searchContent()">Buscar</button>
    <label id="view-toggle">
        <input type="checkbox" onchange="toggleView(this.checked)"> Lista
    </label>
    <select id="source-select">
        <option value="api">API YouTube</option>
        <option value="local">Local JSON</option>
    </select>
    <input type="file" id="local-file" style="display:none;" accept=".json">
</div>

<button onclick="exportSelected()">Exportar Seleccionados (JSON)</button>

<div id="player-area">
    <p>Selecciona un video o disco para reproducir aquÃ­.</p>
    <iframe id="player"></iframe>
</div>

<h2>Resultados:</h2>
<div id="results-container">Introduce un artista o Ã¡lbum para buscar.</div>
<button id="load-more" style="display:none;" onclick="loadMore()">Cargar mÃ¡s resultados</button>

<!-- Modal pantalla completa -->
<div id="fullscreen-modal">
    <iframe id="fullscreen-player" frameborder="0" allowfullscreen></iframe>
    <button id="close-fullscreen">âœ– Cerrar</button>
</div>

<script>
const API_KEY = "AIzaSyDoLnY4t6jHI2OFj7o14ivwXCkjp5UqHMM"; 
const results = document.getElementById("results-container");
const player = document.getElementById("player");
const playerArea = document.getElementById("player-area");
const loadMoreBtn = document.getElementById("load-more");
const sourceSelect = document.getElementById("source-select");
const localFileInput = document.getElementById("local-file");

let nextPageToken = null;
let currentQuery = "";
let cardView = true;
let localData = [];

function toggleView(isList) {
    cardView = !isList;
    results.style.display = cardView ? 'grid' : 'block';
}

function loadContent(id, type) {
    let embedUrl = "";
    if(type === "youtube#video") {
        embedUrl = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&controls=1`;
    } else if(type === "youtube#playlist") {
        embedUrl = `https://www.youtube.com/embed/videoseries?list=${id}&autoplay=1&rel=0&controls=1`;
    } else return;

    player.src = embedUrl;
    playerArea.querySelector('p').style.display = "none";

    player.onerror = () => {
        player.src = "";
        playerArea.querySelector('p').textContent = "Este contenido no se puede reproducir en esta pÃ¡gina.";
        playerArea.querySelector('p').style.display = "block";
    };
}

function openFullscreen(id, type) {
    const modal = document.getElementById('fullscreen-modal');
    const fsPlayer = document.getElementById('fullscreen-player');

    if(type === "youtube#video") {
        fsPlayer.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&controls=1`;
    } else if(type === "youtube#playlist") {
        fsPlayer.src = `https://www.youtube.com/embed/videoseries?list=${id}&autoplay=1&rel=0&controls=1`;
    } else return;

    modal.style.display = "flex";

    document.getElementById('close-fullscreen').onclick = () => {
        fsPlayer.src = "";
        modal.style.display = "none";
    };
}

async function fetchYouTube(query, pageToken = "") {
    let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video,playlist&maxResults=20&q=${encodeURIComponent(query)}&key=${API_KEY}&pageToken=${pageToken}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        return data;
    } catch(err) {
        console.error(err);
        return null;
    }
}

async function searchContent() {
    const query = document.getElementById("query").value.trim();
    if(!query) return;

    currentQuery = query;
    nextPageToken = null;
    results.innerHTML = "Cargando...";
    loadMoreBtn.style.display = "none";

    if(sourceSelect.value === "api") {
        const data = await fetchYouTube(query);
        if(!data || !data.items || data.items.length === 0) {
            results.innerHTML = `<p>No se encontraron resultados para "${query}".</p>`;
            return;
        }
        displayResults(data.items, "api");
        nextPageToken = data.nextPageToken || null;
        loadMoreBtn.style.display = nextPageToken ? "block" : "none";
    } else if(sourceSelect.value === "local") {
        if(localData.length === 0) return alert("No hay datos locales cargados.");
        const filtered = localData.filter(item =>
            item.title.toLowerCase().includes(query.toLowerCase()) ||
            (item.album && item.album.toLowerCase().includes(query.toLowerCase()))
        );
        if(filtered.length === 0) {
            results.innerHTML = `<p>No se encontraron resultados para "${query}" en local.</p>`;
            return;
        }
        displayResults(filtered, "local");
    }
}

function displayResults(items, source) {
    results.innerHTML = "";

    items.forEach(item => {
        const id = source === "api" 
            ? (item.id.kind === "youtube#video" ? item.id.videoId : item.id.playlistId) 
            : item.id;

        const type = source === "api" ? item.id.kind : item.type || "youtube#video";
        const published = source === "api" ? new Date(item.snippet.publishedAt).toLocaleDateString() : item.published || "";
        const thumbnail = source === "api" ? item.snippet.thumbnails.medium.url : item.thumbnail || "https://via.placeholder.com/320x180?text=No+Image";
        const channel = source === "api" ? item.snippet.channelTitle : item.channel || "";
        const album = source === "api" ? "" : item.album || "";

        const div = document.createElement("div");
        div.className = "item";
        div.style.display = cardView ? 'flex' : 'block';

        div.innerHTML = `
            <input type="checkbox" class="select-video"
                data-title="${item.title}"
                data-video-id="${id}"
                data-album="${album}"
                data-thumbnail="${thumbnail}"
                data-channel="${channel}"
                data-published="${published}">
            <img src="${thumbnail}" alt="${item.title}" onclick="loadContent('${id}','${type}')">
            <h3>${item.title}${album ? ' - '+album : ''}</h3>
            <p>Canal: ${channel}</p>
            <p>Publicado: ${published}</p>
            <p>Tipo: ${type === "youtube#video" ? "Video" : "Disco/Playlist"}</p>
            <button onclick="openFullscreen('${id}','${type}')">Pantalla completa</button>
            <p class="status">Sin empezar</p>
        `;
        results.appendChild(div);
    });
}

async function loadMore() {
    if(!nextPageToken || sourceSelect.value !== "api") return;
    const data = await fetchYouTube(currentQuery, nextPageToken);
    if(!data || !data.items || data.items.length === 0) {
        loadMoreBtn.style.display = "none";
        return;
    }
    displayResults(data.items, "api");
    nextPageToken = data.nextPageToken || null;
    loadMoreBtn.style.display = nextPageToken ? "block" : "none";
}

function exportSelected() {
    const selected = document.querySelectorAll('.select-video:checked');
    if(selected.length === 0) return alert("No seleccionaste ningÃºn video");

    const dataLocal = Array.from(selected).map(cb => ({
        title: cb.dataset.title,
        id: cb.dataset.videoId,
        album: cb.dataset.album || "",
        thumbnail: cb.dataset.thumbnail || cb.parentElement.querySelector("img").src,
        channel: cb.dataset.channel || "",
        published: cb.dataset.published || ""
    }));
    localData = dataLocal;

    const dataMP3 = Array.from(selected).map(cb => cb.dataset.videoId);

    const blobLocal = new Blob([JSON.stringify(dataLocal, null, 2)], {type: "application/json"});
    const urlLocal = URL.createObjectURL(blobLocal);
    const aLocal = document.createElement("a");
    aLocal.href = urlLocal;
    aLocal.download = "youtube_local.json";
    aLocal.click();
    URL.revokeObjectURL(urlLocal);

    const blobMP3 = new Blob([JSON.stringify(dataMP3, null, 2)], {type: "application/json"});
    const urlMP3 = URL.createObjectURL(blobMP3);
    const aMP3 = document.createElement("a");
    aMP3.href = urlMP3;
    aMP3.download = "youtube_mp3.json";
    aMP3.click();
    URL.revokeObjectURL(urlMP3);

    alert(`Exportados ${selected.length} items: JSON Local y JSON para conversiÃ³n MP3.`);

    selected.forEach((cb,i) => {
        const status = cb.parentElement.querySelector('.status');
        status.textContent = i === 0 ? 'En proceso' : i === 1 ? 'En curso' : 'Sin empezar';
    });
}

sourceSelect.addEventListener("change", () => {
    if(sourceSelect.value === "local") localFileInput.click();
});

localFileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            localData = JSON.parse(evt.target.result);
            alert(`Archivo local cargado. ${localData.length} items disponibles.`);
            displayResults(localData, "local");
        } catch(err) {
            alert("Error leyendo el archivo JSON.");
            localData = [];
        }
    };
    reader.readAsText(file);
});

document.getElementById("query").addEventListener("keypress", e => {
    if(e.key === "Enter") searchContent();
});
</script>

</body>
</html>
